/*
 * SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./BaseController","./DraftContext","sap/base/Log","sap/ui/model/Context","sap/ui/generic/app/util/ActionUtil"],function(jQuery,t,e,r,n,i){"use strict";var o=t.extend("sap.ui.generic.app.transaction.DraftController",{metadata:{publicMethods:["getDraftContext","getDraftForActiveEntity","createNewDraftEntity","createEditDraftEntity","validateDraftEntity","validateDraft","prepareDraft","prepareDraftEntity","saveAndPrepareDraftEntity","activateDraftEntity","isActiveEntity","hasActiveEntity","destroy","discardDraft"]},constructor:function(e,r){t.apply(this,[e,r]);this.sName="sap.ui.generic.app.transaction.DraftController";this._oContext=null}});o.prototype.getDraftContext=function(){if(!this._oContext){this._oContext=new e(this._oModel)}return this._oContext};o.prototype.createDraft=function(t,e,r){var n=this;if(!t){throw new Error("No entity set")}r=r||{};return new Promise(function(t,i){var o=function(e,r){t({responseData:e,httpResponse:r})};var a;var c=function(t){n._oModel.deleteCreatedEntry(a);i(t)};a=n._oModel.createEntry(e,{properties:r.predefinedValues,success:o,error:c,batchGroupId:r.batchGroupId,changeSetId:r.changeSetId,canonicalRequest:!!r.canonicalRequest,expand:r.expand})})};o.prototype.validateDraft=function(t,e){if(!t.getModel().getObject(t.getPath()).IsActiveEntity){var r=this.getDraftContext().getODataDraftFunctionImportName(t,"ValidationFunction");return this._callAction(r,t,e)}else{return Promise.resolve()}};o.prototype.prepareDraft=function(t,e){if(!t.getModel().getObject(t.getPath()).IsActiveEntity){var r;e=e||{};e.urlParameters=e.urlParameters||{};r=this.getDraftContext().getODataDraftFunctionImportName(t,"PreparationAction");return this._callAction(r,t,e)}else{return Promise.resolve()}};o.prototype.activateDraft=function(t,e,r){var n=this.prepareDraft(t,e);var i=this.getDraftContext().getODataDraftFunctionImportName(t,"ActivationAction");var o=this._callAction(i,t,r);return Promise.all([n,o])};o.prototype.editDraft=function(t,e){var r=this.getDraftContext().getODataDraftFunctionImportName(t,"EditAction");if(r){return this._callAction(r,t,e)}throw new Error(t?"No Edit action defined for the given context":"No context provided for the Edit action")};o.prototype.discardDraft=function(t,e){if(!t){throw new Error("No context")}var r={};jQuery.extend(true,r,e);var n=this.getDraftContext().getODataDraftFunctionImportName(t,"DiscardAction");if(n){return this._callAction(n,t,r)}return this._remove(t.getPath(),r)};o.prototype.getDraftForActive=function(t,e){var r=this;if(!t){throw new Error("No context")}e=e||{};e.urlParameters={$expand:"SiblingEntity"};return this._read(t.getPath(),e).then(function(t){if(t.responseData&&t.responseData.hasOwnProperty("SiblingEntity")){t.context=r._oModel.getContext("/"+r._oModel.getKey(t.responseData.SiblingEntity));return t}throw new Error("No draft entity could be found")})};o.prototype.getDraftForActiveEntity=function(t){var e,r,n=this,i={batchGroupId:"Changes",changeSetId:"Changes",noShowSuccessToast:true,forceSubmit:true};e=this.getDraftForActive(t,i).then(function(t){return t},function(t){throw n._normalizeError(t)});r=this.triggerSubmitChanges(i);return this._returnPromiseAll([e,r])};o.prototype.createNewDraftEntity=function(t,e,o,a,c){var s=this;c=c||{};c.fnSetBusy=c.fnSetBusy||Function.prototype;var u="Changes";var f={predefinedValues:o,batchGroupId:u,changeSetId:u,canonicalRequest:a,expand:c.sRootExpand};var h=new n(s._oModel,e);var d=s.getDraftContext().getODataDraftFunctionImportName(h,"NewAction");var l=d&&s._oMeta.getODataFunctionImport(d);var p,v;if(c.bUseNewActionForCreate&&l){v=function(){var e=s._oMeta.getODataEntityType(s._oMeta.getODataEntitySet(t).entityType)["com.sap.vocabularies.UI.v1.LineItem"];var r=e.find(function(t){return t.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"&&t.Action.String===d});var n=r?r.Label.String:"";return n};var g=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app");var y=v()||l["com.sap.vocabularies.Common.v1.Label"]&&l["com.sap.vocabularies.Common.v1.Label"].String||(c.oFunctionImportDialogInfo?c.oFunctionImportDialogInfo.getTitleText():g.getText("DIALOG_TITLE_NEW_ACTION_FOR_CREATE"));var m=c.oFunctionImportDialogInfo?c.oFunctionImportDialogInfo.getActionButtonText():g.getText("DIALOG_ACTION_BUTTON_NEW_ACTION_FOR_CREATE");var D={ResultIsActiveEntity:true};var E=s.getDraftContext().isDraftEnabled(t);var A=new i({controller:c.oController,contexts:[h],applicationController:c.oApplicationController,operationGrouping:undefined});var _={expand:c.sRootExpand};p=A.call(d,y,E,D,true,_,m).then(function(t){c.fnSetBusy(t.executionPromise);return t.executionPromise})}else{p=this.createDraft(t,e,f);c.fnSetBusy(p)}var C=p.then(function(t){var e=Array.isArray(t)?t[0]:t;return s._normalizeResponse(e.response||e,true)},function(t){var e=t?s._normalizeError(t):null;throw e});function x(t){var e,n,i,o=s._normalizeResponse(t,true);if(o.context){i=o.context.getObject()}if(!i){r.error("Activate function returned no entity");return Promise.reject(new Error("Activate function returned no entity"))}e=s._oDraftUtil.isActiveEntity(i);if(e){r.error("New draft entity is not marked as draft - isActiveEntity = "+e);return Promise.reject("New draft entity is not marked as draft - isActiveEntity = "+e)}n=s._oDraftUtil.hasDraftEntity(i);if(n){r.error("Wrong value for HasTwin of new draft entity - HasDraftEntity = "+n);return Promise.reject(new Error("Wrong value for HasTwin of new draft entity - HasDraftEntity = "+n))}return o}var I;if(c.bUseNewActionForCreate&&l){I=C.then(x)}else{var w={batchGroupId:u,changeSetId:u,noShowSuccessToast:true,forceSubmit:true,failedMsg:"New draft document could not be created"};I=this.triggerSubmitChanges(w).then(function(){return C.then(x)})}return this._returnPromiseAll([C,I])};o.prototype.createEditDraftEntity=function(t,e,n){var i,o,a=this,c={batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Draft for document was created",failedMsg:"Could not create draft for document",forceSubmit:true,context:t,expand:n};if(e){c.urlParameters={PreserveChanges:true}}i=this.editDraft(t,c).then(function(t){var e,n,i;i=a._normalizeResponse(t,true);if(i.context){n=i.context.getObject()}if(!n){r.error("Activate function returned no entity");return Promise.reject(new Error("Activate function returned no entity"))}e=a._oDraftUtil.isActiveEntity(n);if(e){r.error("Edit function returned an entity which is not a draft instance - IsActiveEntity = "+e);return Promise.reject(new Error("Returned entity ist not a draft instance - IsActiveEntity = "+e))}return i},function(t){var e=a._normalizeError(t);throw e});o=this.triggerSubmitChanges(c);return this._returnPromiseAll([i,o])};o.prototype.validateDraftEntity=function(t){var e,r,n=this,i={batchGroupId:"Changes",changeSetId:"Changes",context:t,forceSubmit:true};e=this.validateDraft(t,i).then(function(t){return n._normalizeResponse(t,true)},function(t){var e=n._normalizeError(t);throw e});r=this.triggerSubmitChanges(i);return this._returnPromiseAll([e,r])};o.prototype.saveAndPrepareDraftEntity=function(t,e){var n,i,o=this;e=e||{};e.batchGroupId="Changes";e.changeSetId="Changes";e.successMsg="Saved";e.failedMsg="Save failed";e.context=t;e.forceSubmit=true;n=this.prepareDraft(t,e).then(function(t){var e,n,i;i=o._normalizeResponse(t,true);if(i.context){n=i.context.getObject()}if(!n){r.error("Activate function returned no entity");return Promise.reject(new Error("Activate function returned no entity"))}e=o._oDraftUtil.isActiveEntity(n);if(e){r.error("Prepare function returned an entity which is not a draft instance - IsActiveEntity = "+e);return Promise.reject(new Error("Returned entity ist not a draft instance - IsActiveEntity = "+e))}return i},function(t){var e=o._normalizeError(t);throw e});if(e.binding){e.binding.refresh(true,"Changes")}i=this.triggerSubmitChanges(e);return this._returnPromiseAll([n,i])};o.prototype.prepareDraftEntity=function(t){var e=this;return this.prepareDraft(t).then(function(t){var n,i;n=e._normalizeResponse(t,true);i=n.context.getObject();if(e._oDraftUtil.isActiveEntity(i)){r.error("Prepare function returned an entity which is not a draft instance - IsActiveEntity = "+true);return Promise.reject(new Error("Returned entity ist not a draft instance - IsActiveEntity = "+true))}return n},function(t){var r=e._normalizeError(t);throw r})};o.prototype.activateDraftEntity=function(t,e,n){var i,o;var a=this,c={batchGroupId:"Changes",successMsg:"Document activated",failedMsg:"Activation of document failed",forceSubmit:true,context:t};var s=jQuery.extend({},c);c.changeSetId="Preparation";s.changeSetId="Activation";s.expand=n;var u=e?"lenient":"strict";s.headers={Prefer:"handling="+u};var f=this._oModel.getETag(t.getPath());if(f){c.headers={"If-Match":"*"};s.headers["If-Match"]="*"}var h=new Promise(function(e,n){var u=function(){a.detachOnQueueCompleted(u);i=a.activateDraft(t,c,s).then(function(t){var e,n,i;var o=t[1];i=a._normalizeResponse(o,true);if(i.context){n=i.context.getObject()}if(!n){r.error("Activate function returned no entity");return Promise.reject(new Error("Activate function returned no entity"))}e=a._oDraftUtil.isActiveEntity(n);if(!e){r.error("Activate function returned an entity which is still a draft instance - IsActiveEntity = "+e);return Promise.reject(new Error("Returned entity is still a draft instance - IsActiveEntity = "+e))}return i},function(t){var e=a._normalizeError(t);throw e});o=a.triggerSubmitChanges(c);e(a._returnPromiseAll([i,o]))};if(a._oQueue._aQueue.length){a.attachOnQueueCompleted(u)}else{u(this)}});return h};o.prototype.isActiveEntity=function(t){if(this.getDraftContext().hasDraft(t)){return this._oDraftUtil.isActiveEntity(t.getObject())}return true};o.prototype.hasActiveEntity=function(t){return this._oDraftUtil.hasActiveEntity(t.getObject())};o.prototype.destroy=function(){if(this._oContext){this._oContext.destroy()}this._oContext=null;this._oModel=null;t.prototype.destroy.apply(this,[])};return o},true);
//# sourceMappingURL=DraftController.js.map